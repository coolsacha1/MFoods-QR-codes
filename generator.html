<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MATA Waitlist — QR Code Generator</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://alcdn.msauth.net/browser/2.38.3/js/msal-browser.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Mono:wght@400;500&display=swap');
  * { margin: 0; padding: 0; box-sizing: border-box; }
  :root {
    --bg: #0A0A0A; --surface: #141414; --surface-2: #1C1C1C;
    --border: #2A2A2A; --text: #F5F5F0; --text-muted: #8A8A82;
    --accent: #C8A96E; --accent-dim: rgba(200,169,110,0.1);
    --danger: #D4644E; --success: #6EC87A;
  }
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg); color: var(--text);
    min-height: 100vh; padding: 40px 24px;
  }
  .container { max-width: 520px; margin: 0 auto; }

  /* Auth screen */
  .auth-screen {
    display: flex; flex-direction: column; align-items: center;
    justify-content: center; min-height: 70vh; text-align: center;
  }
  .auth-screen .brand {
    font-size: 13px; font-weight: 500; letter-spacing: 3px;
    text-transform: uppercase; color: var(--accent); margin-bottom: 32px;
  }
  .auth-screen h2 {
    font-size: 22px; font-weight: 400; color: var(--text); margin-bottom: 12px;
  }
  .auth-screen p {
    font-size: 14px; color: var(--text-muted); margin-bottom: 32px; line-height: 1.6;
  }
  .auth-screen .error {
    color: var(--danger); font-size: 13px; margin-top: 16px;
    padding: 12px 16px; background: rgba(212,100,78,0.1);
    border-radius: 8px; display: none;
  }
  .auth-screen .error.visible { display: block; }
  .ms-login-btn {
    display: inline-flex; align-items: center; gap: 12px;
    padding: 14px 28px; background: #FFFFFF; border: none;
    border-radius: 8px; color: #1A1A1A; font-family: 'DM Sans', sans-serif;
    font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;
  }
  .ms-login-btn:hover { opacity: 0.9; transform: translateY(-1px); }
  .ms-login-btn svg { width: 20px; height: 20px; }

  /* User bar */
  .user-bar {
    display: flex; justify-content: space-between; align-items: center;
    margin-bottom: 32px; padding: 12px 16px;
    background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
  }
  .user-bar .user-info {
    font-size: 13px; color: var(--text-muted);
  }
  .user-bar .user-info strong { color: var(--text); font-weight: 500; }
  .user-bar .logout-btn {
    background: none; border: 1px solid var(--border); border-radius: 6px;
    padding: 6px 12px; color: var(--text-muted); font-family: 'DM Sans', sans-serif;
    font-size: 12px; cursor: pointer; transition: all 0.2s;
  }
  .user-bar .logout-btn:hover { border-color: var(--danger); color: var(--danger); }

  .app-content { display: none; }
  .app-content.visible { display: block; }

  .header { margin-bottom: 48px; }
  .header h1 {
    font-size: 13px; font-weight: 500; letter-spacing: 3px;
    text-transform: uppercase; color: var(--accent); margin-bottom: 8px;
  }
  .header p { font-size: 14px; color: var(--text-muted); line-height: 1.6; }

  .section { margin-bottom: 32px; }
  .section-label {
    font-size: 11px; font-weight: 500; letter-spacing: 2px;
    text-transform: uppercase; color: var(--text-muted); margin-bottom: 16px;
  }

  .service-toggle { display: flex; gap: 8px; margin-bottom: 24px; }
  .service-btn {
    flex: 1; padding: 14px 20px; background: var(--surface);
    border: 1px solid var(--border); border-radius: 8px;
    color: var(--text-muted); font-family: 'DM Sans', sans-serif;
    font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s;
  }
  .service-btn:hover { border-color: var(--accent); color: var(--text); }
  .service-btn.active {
    background: var(--accent-dim); border-color: var(--accent); color: var(--accent);
  }
  .service-btn span {
    display: block; font-family: 'DM Mono', monospace;
    font-size: 12px; color: var(--text-muted); margin-top: 4px;
  }
  .service-btn.active span { color: var(--accent); opacity: 0.7; }

  .date-row { margin-bottom: 16px; }
  .time-row { display: flex; gap: 12px; margin-bottom: 24px; }
  .input-group { flex: 1; }
  .input-group label {
    display: block; font-size: 11px; font-weight: 500; letter-spacing: 1px;
    text-transform: uppercase; color: var(--text-muted); margin-bottom: 8px;
  }
  input[type="date"], input[type="time"] {
    background: var(--surface); border: 1px solid var(--border); border-radius: 8px;
    padding: 12px 14px; color: var(--text); font-family: 'DM Mono', monospace;
    font-size: 14px; width: 100%; outline: none; transition: border-color 0.2s;
  }
  input[type="date"]:focus, input[type="time"]:focus { border-color: var(--accent); }

  .generate-btn {
    width: 100%; padding: 16px; background: var(--accent); border: none;
    border-radius: 8px; color: var(--bg); font-family: 'DM Sans', sans-serif;
    font-size: 14px; font-weight: 600; letter-spacing: 1px;
    text-transform: uppercase; cursor: pointer; transition: all 0.2s;
  }
  .generate-btn:hover { opacity: 0.9; transform: translateY(-1px); }
  .generate-btn:active { transform: translateY(0); }

  .qr-output { display: none; margin-top: 40px; text-align: center; }
  .qr-output.visible { display: block; }
  .qr-card {
    background: #FFFFFF; border-radius: 16px;
    padding: 40px 40px 32px; display: inline-block;
  }
  .qr-card-brand {
    font-family: 'DM Sans', sans-serif; font-size: 11px; font-weight: 600;
    letter-spacing: 3px; text-transform: uppercase; color: #1A1A1A; margin-bottom: 24px;
  }
  #qr-container { display: flex; justify-content: center; margin-bottom: 20px; }
  #qr-container canvas, #qr-container img { border-radius: 4px; }
  .qr-card-info {
    font-family: 'DM Mono', monospace; font-size: 11px; color: #999; line-height: 1.8;
  }
  .qr-card-info .service-name {
    font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 600;
    color: #333; text-transform: uppercase; letter-spacing: 2px;
  }

  .qr-meta {
    margin-top: 24px; padding: 16px; background: var(--surface);
    border-radius: 8px; text-align: left;
  }
  .qr-meta-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 6px 0; font-size: 13px;
  }
  .qr-meta-row .label { color: var(--text-muted); }
  .qr-meta-row .value {
    font-family: 'DM Mono', monospace; font-size: 12px; color: var(--text);
  }

  .actions { margin-top: 20px; display: flex; gap: 8px; }
  .action-btn {
    flex: 1; padding: 12px; background: var(--surface);
    border: 1px solid var(--border); border-radius: 8px;
    color: var(--text); font-family: 'DM Sans', sans-serif;
    font-size: 13px; font-weight: 500; cursor: pointer; transition: all 0.2s;
  }
  .action-btn:hover { border-color: var(--accent); color: var(--accent); }

  .encoded-url {
    margin-top: 16px; padding: 12px; background: var(--surface-2);
    border-radius: 6px; font-family: 'DM Mono', monospace; font-size: 11px;
    color: var(--text-muted); word-break: break-all; line-height: 1.6; display: none;
  }
  .encoded-url.visible { display: block; }

  .how-it-works {
    margin-top: 48px; padding: 24px; background: var(--surface);
    border-radius: 12px; border: 1px solid var(--border);
  }
  .how-it-works h3 {
    font-size: 11px; font-weight: 500; letter-spacing: 2px;
    text-transform: uppercase; color: var(--accent); margin-bottom: 16px;
  }
  .how-it-works p {
    font-size: 13px; color: var(--text-muted); line-height: 1.8; margin-bottom: 12px;
  }
  .how-it-works p:last-child { margin-bottom: 0; }
  .step-num {
    display: inline-block; width: 20px; height: 20px; border-radius: 50%;
    background: var(--accent-dim); color: var(--accent); font-size: 11px;
    font-weight: 600; text-align: center; line-height: 20px; margin-right: 8px;
  }
</style>
</head>
<body>
<div class="container">

  <!-- AUTH SCREEN -->
  <div class="auth-screen" id="auth-screen">
    <div class="brand">MATA Waitlist</div>
    <h2>QR Code Generator</h2>
    <p>Sign in with your MATA company account to generate time-limited QR codes for the restaurant waitlist.</p>
    <button class="ms-login-btn" onclick="signIn()">
      <svg viewBox="0 0 21 21"><rect x="1" y="1" width="9" height="9" fill="#F25022"/><rect x="11" y="1" width="9" height="9" fill="#7FBA00"/><rect x="1" y="11" width="9" height="9" fill="#00A4EF"/><rect x="11" y="11" width="9" height="9" fill="#FFB900"/></svg>
      Sign in with Microsoft
    </button>
    <div class="error" id="auth-error"></div>
  </div>

  <!-- APP CONTENT (hidden until authenticated) -->
  <div class="app-content" id="app-content">

    <div class="user-bar">
      <div class="user-info">Signed in as <strong id="user-email"></strong></div>
      <button class="logout-btn" onclick="signOut()">Sign out</button>
    </div>

    <div class="header">
      <h1>MATA Waitlist</h1>
      <p>Generate time-limited QR codes for each service. Customers scan the QR → gate validates São Paulo time → redirects to waitlist.</p>
    </div>

    <!-- Service Selection -->
    <div class="section">
      <div class="section-label">Service</div>
      <div class="service-toggle">
        <button class="service-btn active" data-service="lunch" data-start="11:30" data-end="15:30" onclick="selectService(this)">
          Lunch <span>11:30 — 15:30</span>
        </button>
        <button class="service-btn" data-service="dinner" data-start="18:30" data-end="23:00" onclick="selectService(this)">
          Dinner <span>18:30 — 23:00</span>
        </button>
      </div>
    </div>

    <!-- Date & Time -->
    <div class="section">
      <div class="section-label">Date & Time Window</div>
      <div class="date-row">
        <input type="date" id="service-date">
      </div>
      <div class="time-row">
        <div class="input-group">
          <label>From</label>
          <input type="time" id="time-start" value="11:30">
        </div>
        <div class="input-group">
          <label>Until</label>
          <input type="time" id="time-end" value="15:30">
        </div>
      </div>
    </div>

    <button class="generate-btn" onclick="generateQR()">Generate QR Code</button>

    <!-- QR Output -->
    <div class="qr-output" id="qr-output">
      <div class="qr-card" id="qr-card">
        <div class="qr-card-brand">MATA · Waitlist</div>
        <div id="qr-container"></div>
        <div class="qr-card-info">
          <div class="service-name" id="qr-service-label">Lunch</div>
          <div id="qr-date-label"></div>
          <div id="qr-time-label"></div>
        </div>
      </div>

      <div class="qr-meta">
        <div class="qr-meta-row">
          <span class="label">Timezone</span>
          <span class="value">America/Sao_Paulo</span>
        </div>
        <div class="qr-meta-row">
          <span class="label">Valid window</span>
          <span class="value" id="meta-window"></span>
        </div>
        <div class="qr-meta-row">
          <span class="label">Gate page</span>
          <span class="value" id="meta-gate" style="font-size: 10px; opacity: 0.7;"></span>
        </div>
      </div>

      <div class="encoded-url" id="encoded-url"></div>

      <div class="actions">
        <button class="action-btn" onclick="printQR()">Print</button>
        <button class="action-btn" onclick="downloadQR()">Download PNG</button>
        <button class="action-btn" onclick="toggleURL()">Show URL</button>
      </div>
    </div>

    <div class="how-it-works">
      <h3>How it works</h3>
      <p><span class="step-num">1</span>Select the service (Lunch or Dinner) and the date.</p>
      <p><span class="step-num">2</span>Generate the QR code. Print it and place it at the host stand.</p>
      <p><span class="step-num">3</span>Customers scan → gate checks São Paulo time → redirects to waitlist or shows expired.</p>
      <p style="margin-top: 12px; color: var(--accent); font-size: 12px;">All time validation uses Brasília time (UTC-3), regardless of the customer's phone timezone.</p>
    </div>
  </div>
</div>

<script>
  // ═══════════════════════════════════════════════════════════════
  // CONFIGURATION
  // ═══════════════════════════════════════════════════════════════

  const GATE_URL = 'https://mfoods-qr-codes.vercel.app';

  const MSAL_CONFIG = {
    auth: {
      clientId: '0a0c061d-1c71-4ca4-b86a-55b99c141129',
      authority: 'https://login.microsoftonline.com/common',
      redirectUri: window.location.origin + '/generator.html'
    },
    cache: {
      cacheLocation: 'sessionStorage',
      storeAuthStateInCookie: false
    }
  };

  // Whitelisted domains and individual emails
  const ALLOWED_DOMAINS = [
    'matacompany.com'
  ];
  const ALLOWED_EMAILS = [
    // Add individual emails here if needed:
    // 'partner@otherdomain.com'
  ];

  // ═══════════════════════════════════════════════════════════════
  // AUTH
  // ═══════════════════════════════════════════════════════════════

  const msalInstance = new msal.PublicClientApplication(MSAL_CONFIG);

  function isEmailAllowed(email) {
    if (!email) return false;
    const lower = email.toLowerCase();
    if (ALLOWED_EMAILS.map(e => e.toLowerCase()).includes(lower)) return true;
    const domain = lower.split('@')[1];
    return ALLOWED_DOMAINS.map(d => d.toLowerCase()).includes(domain);
  }

  function showError(msg) {
    const el = document.getElementById('auth-error');
    el.textContent = msg;
    el.classList.add('visible');
  }

  function showApp(email) {
    document.getElementById('auth-screen').style.display = 'none';
    document.getElementById('app-content').classList.add('visible');
    document.getElementById('user-email').textContent = email;
    document.getElementById('service-date').value = new Date().toISOString().split('T')[0];
  }

  async function signIn() {
    try {
      const response = await msalInstance.loginPopup({
        scopes: ['openid', 'profile', 'email', 'User.Read']
      });
      const email = response.account.username || response.account.idTokenClaims?.email;
      if (!isEmailAllowed(email)) {
        await msalInstance.logoutPopup();
        showError(`Access denied. ${email} is not authorized to use this tool. Contact your administrator.`);
        return;
      }
      showApp(email);
    } catch (error) {
      if (error.errorCode === 'user_cancelled') return;
      console.error('Login error:', error);
      showError('Sign-in failed. Please try again.');
    }
  }

  function signOut() {
    msalInstance.logoutPopup().then(() => {
      document.getElementById('auth-screen').style.display = '';
      document.getElementById('app-content').classList.remove('visible');
      document.getElementById('auth-error').classList.remove('visible');
    });
  }

  async function checkExistingSession() {
    await msalInstance.initialize();
    try { await msalInstance.handleRedirectPromise(); } catch(e) {}
    const accounts = msalInstance.getAllAccounts();
    if (accounts.length > 0) {
      const email = accounts[0].username;
      if (isEmailAllowed(email)) {
        showApp(email);
      }
    }
  }

  checkExistingSession();

  // ═══════════════════════════════════════════════════════════════
  // QR GENERATOR
  // ═══════════════════════════════════════════════════════════════

  function selectService(btn) {
    document.querySelectorAll('.service-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('time-start').value = btn.dataset.start;
    document.getElementById('time-end').value = btn.dataset.end;
  }

  function generateQR() {
    const date = document.getElementById('service-date').value;
    const timeStart = document.getElementById('time-start').value;
    const timeEnd = document.getElementById('time-end').value;
    const service = document.querySelector('.service-btn.active').dataset.service;

    if (!date || !timeStart || !timeEnd) {
      alert('Please fill in all fields.');
      return;
    }

    const validFrom = new Date(`${date}T${timeStart}:00`).getTime();
    const validUntil = new Date(`${date}T${timeEnd}:00`).getTime();

    if (validUntil <= validFrom) {
      alert('End time must be after start time.');
      return;
    }

    const params = new URLSearchParams({
      f: validFrom.toString(36),
      u: validUntil.toString(36),
      s: service.charAt(0)
    });

    const fullURL = `${GATE_URL}?${params.toString()}`;

    const container = document.getElementById('qr-container');
    container.innerHTML = '';

    new QRCode(container, {
      text: fullURL,
      width: 220, height: 220,
      colorDark: '#1A1A1A', colorLight: '#FFFFFF',
      correctLevel: QRCode.CorrectLevel.M
    });

    document.getElementById('qr-service-label').textContent =
      service.charAt(0).toUpperCase() + service.slice(1);
    const dateObj = new Date(date + 'T12:00:00');
    document.getElementById('qr-date-label').textContent =
      dateObj.toLocaleDateString('en-GB', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
    document.getElementById('qr-time-label').textContent = `${timeStart} — ${timeEnd}`;
    document.getElementById('meta-window').textContent = `${timeStart} — ${timeEnd}`;
    document.getElementById('meta-gate').textContent = GATE_URL;
    document.getElementById('encoded-url').textContent = fullURL;
    document.getElementById('qr-output').classList.add('visible');
  }

  function printQR() {
    const w = window.open('', '_blank');
    w.document.write(`<html><head>
      <style>
        @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;600&family=DM+Mono&display=swap');
        body { display:flex; justify-content:center; align-items:center; min-height:100vh; margin:0; font-family:'DM Sans',sans-serif; }
        .card { text-align:center; padding:48px; border:1px solid #E0E0E0; border-radius:16px; }
        .brand { font-size:11px; font-weight:600; letter-spacing:3px; text-transform:uppercase; color:#1A1A1A; margin-bottom:32px; }
        .svc { font-size:14px; font-weight:600; letter-spacing:2px; text-transform:uppercase; color:#333; margin-top:24px; }
        .info { font-family:'DM Mono',monospace; font-size:12px; color:#999; margin-top:4px; line-height:1.8; }
      </style></head><body>
      <div class="card">
        <div class="brand">MATA · Waitlist</div>
        ${document.getElementById('qr-container').innerHTML}
        <div class="svc">${document.getElementById('qr-service-label').textContent}</div>
        <div class="info">${document.getElementById('qr-date-label').textContent}</div>
        <div class="info">${document.getElementById('qr-time-label').textContent}</div>
      </div>
      <script>setTimeout(()=>window.print(),500)<\/script>
    </body></html>`);
    w.document.close();
  }

  function downloadQR() {
    const canvas = document.querySelector('#qr-container canvas');
    if (canvas) {
      const a = document.createElement('a');
      a.download = `mata-waitlist-${document.getElementById('service-date').value}-${document.querySelector('.service-btn.active').dataset.service}.png`;
      a.href = canvas.toDataURL();
      a.click();
    }
  }

  function toggleURL() {
    document.getElementById('encoded-url').classList.toggle('visible');
  }
</script>
</body>
</html>
