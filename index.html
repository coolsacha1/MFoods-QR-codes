<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MATA — Waitlist</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0A0A0A">
<style>
  @import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&display=swap');
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: #0A0A0A;
    color: #F5F5F0;
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
  }
  .gate { text-align: center; max-width: 380px; width: 100%; }
  .gate-brand {
    font-size: 11px; font-weight: 600; letter-spacing: 4px;
    text-transform: uppercase; color: #C8A96E; margin-bottom: 48px;
  }
  .gate-icon {
    width: 64px; height: 64px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 32px; font-size: 28px;
  }
  .gate-icon.valid { background: rgba(110,200,122,0.1); border: 1px solid rgba(110,200,122,0.2); }
  .gate-icon.expired { background: rgba(212,100,78,0.1); border: 1px solid rgba(212,100,78,0.2); }
  .gate-icon.loading { background: rgba(200,169,110,0.1); border: 1px solid rgba(200,169,110,0.2); }
  .gate h1 { font-size: 22px; font-weight: 600; margin-bottom: 12px; line-height: 1.3; }
  .gate p { font-size: 14px; color: #8A8A82; line-height: 1.7; margin-bottom: 32px; }
  .gate-btn {
    display: inline-block; padding: 16px 40px; background: #C8A96E;
    color: #0A0A0A; text-decoration: none; border-radius: 8px;
    font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 600;
    letter-spacing: 1px; text-transform: uppercase; transition: opacity 0.2s;
  }
  .gate-btn:hover { opacity: 0.9; }
  .spinner {
    width: 24px; height: 24px;
    border: 2px solid rgba(200,169,110,0.3); border-top-color: #C8A96E;
    border-radius: 50%; animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .state { display: none; }
  .state.active { display: block; }
</style>
</head>
<body>
<div class="gate">
  <div class="gate-brand">MATA</div>

  <div class="state active" id="state-loading">
    <div class="gate-icon loading"><div class="spinner"></div></div>
    <h1>Validating...</h1>
    <p>Checking your access code.</p>
  </div>

  <div class="state" id="state-valid">
    <div class="gate-icon valid">✓</div>
    <h1>Welcome!</h1>
    <p>Redirecting you to the waitlist...</p>
    <a href="#" class="gate-btn" id="manual-redirect">Join Waitlist</a>
  </div>

  <div class="state" id="state-expired">
    <div class="gate-icon expired">✕</div>
    <h1>This code has expired</h1>
    <p>This QR code is no longer valid. Please scan the current QR code at the restaurant to join the waitlist.</p>
  </div>

  <div class="state" id="state-early">
    <div class="gate-icon expired">⏳</div>
    <h1>Not yet available</h1>
    <p>This waitlist opens at <span id="opens-at"></span> (Brasília time). Please scan the QR code at the restaurant during service hours.</p>
  </div>

  <div class="state" id="state-invalid">
    <div class="gate-icon expired">✕</div>
    <h1>Invalid code</h1>
    <p>This QR code is not recognized. Please scan the QR code displayed at the restaurant.</p>
  </div>
</div>

<script>
  // === CONFIGURATION ===
  // Hardcoded destination — QR params cannot override this (anti-tampering)
  const WAITLIST_URL = 'https://share.superapp-mtz.com/foods/waitlist?id=8ef837e5-c7d0-4485-b6bb-06088347550f';

  function showState(id) {
    document.querySelectorAll('.state').forEach(s => s.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }

  // Get current São Paulo time as epoch ms — works regardless of user's phone timezone
  function getSaoPauloTimestamp() {
    // Intl API gives us the actual wall-clock time in São Paulo
    const fmt = new Intl.DateTimeFormat('en-US', {
      timeZone: 'America/Sao_Paulo',
      year: 'numeric', month: '2-digit', day: '2-digit',
      hour: '2-digit', minute: '2-digit', second: '2-digit',
      hour12: false
    });
    const parts = {};
    fmt.formatToParts(new Date()).forEach(p => { parts[p.type] = p.value; });
    // Build an ISO-ish string and parse it as a local date (no timezone offset)
    // This gives us a Date object whose .getTime() represents "right now in SP"
    const isoStr = `${parts.year}-${parts.month}-${parts.day}T${parts.hour}:${parts.minute}:${parts.second}`;
    return new Date(isoStr).getTime();
  }

  function validate() {
    const params = new URLSearchParams(window.location.search);
    const validFromB36 = params.get('f');
    const validUntilB36 = params.get('u');

    if (!validFromB36 || !validUntilB36) {
      showState('state-invalid');
      return;
    }

    try {
      // Decode timestamps — these were encoded in the generator using São Paulo local time
      const validFrom = parseInt(validFromB36, 36);
      const validUntil = parseInt(validUntilB36, 36);

      // Sanity: timestamps should be between 2024–2030
      const min = new Date('2024-01-01').getTime();
      const max = new Date('2030-12-31').getTime();
      if (validFrom < min || validFrom > max || validUntil < min || validUntil > max) {
        showState('state-invalid');
        return;
      }

      // Sanity: window shouldn't exceed 12 hours
      if (validUntil - validFrom > 12 * 60 * 60 * 1000) {
        showState('state-invalid');
        return;
      }

      // Compare using São Paulo wall-clock time
      const nowSP = getSaoPauloTimestamp();

      if (nowSP < validFrom) {
        const d = new Date(validFrom);
        const h = String(d.getHours()).padStart(2, '0');
        const m = String(d.getMinutes()).padStart(2, '0');
        document.getElementById('opens-at').textContent = `${h}:${m}`;
        showState('state-early');
        return;
      }

      if (nowSP > validUntil) {
        showState('state-expired');
        return;
      }

      // === VALID ===
      showState('state-valid');
      document.getElementById('manual-redirect').href = WAITLIST_URL;
      setTimeout(() => { window.location.href = WAITLIST_URL; }, 1500);

    } catch (e) {
      showState('state-invalid');
    }
  }

  setTimeout(validate, 800);
</script>
</body>
</html>
